// forked from https://github.com/superguigui/Wagner/blob/master/example/index.js

import {
  Mesh,
  RepeatWrapping,
  Vector2,
  BoxGeometry,
  MeshBasicMaterial,
  MeshPhongMaterial,
  TextureLoader,
  Object3D,
  AmbientLight,
  SpotLight,
  PCFShadowMap,
  SmoothShading,
  CameraHelper, LinearFilter, RGBAFormat, WebGLRenderTarget, Color
} from 'three'
import dat from 'dat-gui'
import AbstractApplication from 'views/AbstractApplication'
import { mergeBufferGeometries } from 'three/examples/jsm/utils/BufferGeometryUtils.js';
import { EffectComposer } from 'three/examples/jsm/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/examples/jsm/postprocessing/RenderPass.js';

import {MultiPassBloomPass} from "@/js/passes/bloom/MultiPassBloomPass"

class Main extends AbstractApplication {
  constructor () {
    super()

    this.renderer.setClearColor(new Color(0x000000))

    this.modelMaterial = new MeshPhongMaterial( {
      map: new TextureLoader().load( './static/textures/1324-decal.jpg' ),
      normalMap: new TextureLoader().load( './static/textures/1324-normal.jpg' ),
      shininess: 10,
      flatShading: false
    } );

    var SHADOW_MAP_WIDTH = 2048, SHADOW_MAP_HEIGHT = 1024;

    var ambient = new AmbientLight( 0x444444 );
    this.scene.add( ambient );

    const light = new SpotLight( 0xaaaaaa);
    light.position.set( 0, 1500, 1000 );
    light.target.position.set( 0, 0, 0 );

    light.castShadow = true;

    light.shadow.camera.near = 1200;
    light.shadow.camera.far = 2500;
    light.shadow.camera.fov = 90;

    //light.shadowCameraVisible = true;

    light.shadow.bias = 0.0001;
    light.shadow.darkness = 0.5;

    light.shadow.mapSize.width = SHADOW_MAP_WIDTH;
    light.shadow.mapSize.height = SHADOW_MAP_HEIGHT;

    this.scene.add( light );
    this.scene.add( new CameraHelper( light.shadow.camera ) );

    this.light = light;

    this.renderer.setPixelRatio( window.devicePixelRatio );
    // this.renderer.shadowMap.enabled = true;
    // this.renderer.shadowMap.type = PCFShadowMap;

    this.glowMaterial = new MeshBasicMaterial( {
      // emissive: 0xffffff,
      map: new TextureLoader().load( './static/textures/1324-glow.jpg' ),
    } );

    this.glowMaterial.map.repeat = new Vector2( 1, 1 );
    this.glowMaterial.map.wrapS = this.glowMaterial.map.wrapT = RepeatWrapping;
    const pars = { minFilter: LinearFilter, magFilter: LinearFilter, format: RGBAFormat };
    this.glowTexture = new WebGLRenderTarget( window.innerWidth, window.innerHeight, pars );

    this.createCubes();

    this.composer = new EffectComposer( this.renderer);
    this.composer.addPass( new RenderPass( this.scene, this.camera ) );
    this.bloomPass = new MultiPassBloomPass({
      strength:.5,
      zoomBlurStrength: 2,
      blurAmount: 2,
      applyZoomBlur: false,
      useTexture: false
    });
    this.bloomPass.strength = .5;
    this.composer.addPass( this.bloomPass );

    const gui = new dat.GUI();

    gui.add( this.bloomPass.options, 'blurAmount' ).min(0).max(2);
    gui.add( this.bloomPass.options, 'applyZoomBlur' );
    gui.add( this.bloomPass.options, 'zoomBlurStrength' ).min(0).max(2);
    gui.add( this.bloomPass.options, 'useTexture' );
    gui.open();

    this.onWindowResize();
    this.animate()
  }

  onWindowResize () {
    super.onWindowResize();
    this.composer.setSize( window.innerWidth, window.innerHeight );
    this.bloomPass.options.zoomBlurCenter.set( .5 * window.innerWidth, .5 * window.innerHeight );
    this.glowTexture.setSize( window.innerWidth, window.innerHeight );
  }

  createCubes() {

    var s = new BoxGeometry( 10, 10, 10, 1, 1 ,1 );
    var gg = [];
    var r = 2000;
    var rr =[{"_x":3.275894132844844,"_y":5.343915300664303,"_z":1.5614047302712586,"_order":"XYZ"},{"_x":0.2237455562347016,"_y":3.874500809865961,"_z":3.1233496072565337,"_order":"XYZ"},{"_x":6.159086164406961,"_y":4.99499550005312,"_z":2.6153154231911677,"_order":"XYZ"},{"_x":3.9067899254073737,"_y":4.121273711253057,"_z":0.6389165822518842,"_order":"XYZ"},{"_x":1.8028885525879272,"_y":5.168314585058831,"_z":4.001864675658858,"_order":"XYZ"},{"_x":2.8709549158773013,"_y":1.3599926174434913,"_z":4.864475177538541,"_order":"XYZ"},{"_x":4.881657883277796,"_y":5.17654436546465,"_z":2.4411952019477168,"_order":"XYZ"},{"_x":1.1787314031026754,"_y":2.655688200662436,"_z":5.196258472949448,"_order":"XYZ"},{"_x":0.4900434478933996,"_y":1.8380985133049215,"_z":3.7047844210978518,"_order":"XYZ"},{"_x":5.566074359958734,"_y":1.0753034554869962,"_z":1.0104490807647863,"_order":"XYZ"},{"_x":3.641372548053026,"_y":6.221457033627615,"_z":5.775621556484803,"_order":"XYZ"},{"_x":2.32033748771977,"_y":1.686442057721508,"_z":1.9627900882276088,"_order":"XYZ"},{"_x":3.767403908154991,"_y":1.2244192129636524,"_z":5.87983620249232,"_order":"XYZ"},{"_x":4.533540891932541,"_y":0.21152237431649035,"_z":1.6685785782348612,"_order":"XYZ"},{"_x":0.4845699844991988,"_y":4.941313308406324,"_z":3.8807693612603225,"_order":"XYZ"},{"_x":1.3992198405074063,"_y":5.958063228245825,"_z":4.522572678150933,"_order":"XYZ"},{"_x":2.5042598521448096,"_y":4.4151360045663,"_z":5.881659265350304,"_order":"XYZ"},{"_x":3.2772084393361625,"_y":1.1581295351293972,"_z":0.9013519471219315,"_order":"XYZ"},{"_x":0.3432124947296269,"_y":2.106381431969615,"_z":2.9845155163194224,"_order":"XYZ"},{"_x":0.42719251532011226,"_y":0.8540023117478898,"_z":3.357338461731544,"_order":"XYZ"},{"_x":2.3768816039496956,"_y":1.0338846297120587,"_z":0.7119261334098681,"_order":"XYZ"},{"_x":4.254065650848398,"_y":3.49292946350729,"_z":3.2272219081421385,"_order":"XYZ"},{"_x":3.4899190494732237,"_y":5.571922397510815,"_z":5.172718600917575,"_order":"XYZ"},{"_x":2.313937268895703,"_y":3.730455640811903,"_z":3.4139298654348362,"_order":"XYZ"},{"_x":3.064270944163717,"_y":4.888010260544595,"_z":0.29391213280908773,"_order":"XYZ"},{"_x":3.5765731738216973,"_y":4.371765842429846,"_z":2.205126203517014,"_order":"XYZ"},{"_x":2.830537364107195,"_y":4.213566863646815,"_z":2.8636512686962363,"_order":"XYZ"},{"_x":0.14574740617889217,"_y":0.27118062469085336,"_z":2.4786930532408356,"_order":"XYZ"},{"_x":0.0311597242634597,"_y":1.9430722581952773,"_z":0.717626117319739,"_order":"XYZ"},{"_x":4.950570500875364,"_y":3.722508337261649,"_z":1.7260662628088401,"_order":"XYZ"},{"_x":4.737649858456576,"_y":3.2776865852966064,"_z":1.9289276903426964,"_order":"XYZ"},{"_x":5.16826113595939,"_y":4.137406473533315,"_z":5.476374813070122,"_order":"XYZ"},{"_x":0.8313505902352236,"_y":5.585539298907363,"_z":4.802830186197673,"_order":"XYZ"},{"_x":3.5599324821159475,"_y":1.1349392355824928,"_z":0.8572470496276464,"_order":"XYZ"},{"_x":0.509344931861501,"_y":1.7772656983558557,"_z":2.8873863910672877,"_order":"XYZ"},{"_x":4.341797039554522,"_y":3.1844644623154945,"_z":0.7377932155095894,"_order":"XYZ"},{"_x":1.2066873289499611,"_y":0.11704442933987716,"_z":1.1437572780035716,"_order":"XYZ"},{"_x":1.7627583765995625,"_y":0.8084929524262757,"_z":6.044929604313719,"_order":"XYZ"},{"_x":3.325251494775498,"_y":0.4798139828452221,"_z":2.930284469866756,"_order":"XYZ"},{"_x":5.62606501627142,"_y":3.744958644646288,"_z":1.0016956967210844,"_order":"XYZ"},{"_x":3.1888693876715934,"_y":4.606611267409261,"_z":4.188538710520845,"_order":"XYZ"},{"_x":2.1673807123964854,"_y":3.9089953001852735,"_z":0.6104036681862309,"_order":"XYZ"},{"_x":0.3815633924427992,"_y":5.541491872131384,"_z":0.13763876406315995,"_order":"XYZ"},{"_x":4.759653259284988,"_y":3.615239056884452,"_z":5.998478811108133,"_order":"XYZ"},{"_x":4.784693438020738,"_y":1.5463934446777106,"_z":3.0498178387304553,"_order":"XYZ"},{"_x":5.35170914311444,"_y":5.217771264392649,"_z":3.627914458497146,"_order":"XYZ"},{"_x":0.746275383348082,"_y":6.110222472345295,"_z":3.8250556135906297,"_order":"XYZ"},{"_x":4.831198109527961,"_y":0.8051769629211378,"_z":3.965497833080589,"_order":"XYZ"},{"_x":3.6836930090122855,"_y":5.280918017331134,"_z":3.0697608836033394,"_order":"XYZ"},{"_x":1.6469262698768021,"_y":4.040865851283888,"_z":4.810550374692097,"_order":"XYZ"},{"_x":0.8366243118112161,"_y":0.15051988634292432,"_z":6.241874075895179,"_order":"XYZ"},{"_x":0.1506417579066995,"_y":1.8904499224558724,"_z":0.5660736351606206,"_order":"XYZ"},{"_x":5.124892488768517,"_y":3.383157541462537,"_z":2.281324560430188,"_order":"XYZ"},{"_x":2.090007165050037,"_y":1.4859459486633875,"_z":6.154093164817767,"_order":"XYZ"},{"_x":4.23020495828864,"_y":3.3623473142344116,"_z":5.6853026344624675,"_order":"XYZ"},{"_x":0.09326496652030443,"_y":3.3055466149642516,"_z":0.7585517075966912,"_order":"XYZ"},{"_x":0.6051423540737486,"_y":0.694747711988885,"_z":5.436135684383872,"_order":"XYZ"},{"_x":4.414875884929011,"_y":4.520388612294802,"_z":4.791417292456824,"_order":"XYZ"},{"_x":2.851270366827963,"_y":2.013082367426896,"_z":2.5879883574430416,"_order":"XYZ"},{"_x":3.25836816294261,"_y":3.416371385154795,"_z":3.301171249484214,"_order":"XYZ"},{"_x":4.811016335869257,"_y":2.3983478357486883,"_z":3.7768353965435972,"_order":"XYZ"},{"_x":2.3098821940135124,"_y":6.170655791750942,"_z":3.892222508721898,"_order":"XYZ"},{"_x":4.997659228712625,"_y":4.589797933438671,"_z":5.0254474466209995,"_order":"XYZ"},{"_x":1.6413295225110331,"_y":0.2410205151160749,"_z":3.3371143846107394,"_order":"XYZ"},{"_x":4.3133685061719,"_y":5.396016505454506,"_z":2.3364693318070615,"_order":"XYZ"},{"_x":2.604239368018967,"_y":2.1402016633319185,"_z":4.866352551412033,"_order":"XYZ"},{"_x":2.974125564140268,"_y":4.3306013114822015,"_z":1.957401074966134,"_order":"XYZ"},{"_x":0.12126081505644276,"_y":3.0617816273034686,"_z":0.4750624786866505,"_order":"XYZ"},{"_x":0.275106221088582,"_y":3.4564925535811004,"_z":4.541652908297482,"_order":"XYZ"},{"_x":5.246830175288231,"_y":2.37441074739323,"_z":4.6702404941292075,"_order":"XYZ"},{"_x":3.153511171239857,"_y":0.8265670226580645,"_z":4.422337096408694,"_order":"XYZ"},{"_x":5.102737219298263,"_y":4.401794483316113,"_z":4.69910354189896,"_order":"XYZ"},{"_x":4.799710286142649,"_y":0.023306109430996005,"_z":2.41551537676827,"_order":"XYZ"},{"_x":3.0798742213322106,"_y":5.0757689576396805,"_z":5.784919692814582,"_order":"XYZ"},{"_x":4.575884850452502,"_y":0.09136410885328365,"_z":4.5566876846452775,"_order":"XYZ"},{"_x":4.541359490918657,"_y":1.725952138583123,"_z":3.9231239399116933,"_order":"XYZ"},{"_x":4.345046265063969,"_y":6.170934546976983,"_z":3.7097698978154736,"_order":"XYZ"},{"_x":3.062514560866027,"_y":2.214486255598012,"_z":5.135501004743431,"_order":"XYZ"},{"_x":5.452080277035407,"_y":2.3913856510227314,"_z":0.6122445806372653,"_order":"XYZ"},{"_x":3.1443516593140686,"_y":1.5323160886321106,"_z":2.789532686637396,"_order":"XYZ"},{"_x":2.806756729587572,"_y":5.597122776417345,"_z":1.2686692592403228,"_order":"XYZ"},{"_x":1.2092562203725299,"_y":0.5578110832582723,"_z":2.901942849346309,"_order":"XYZ"},{"_x":6.124901364165257,"_y":6.095873740037072,"_z":4.599520598482858,"_order":"XYZ"},{"_x":1.2467667615276559,"_y":2.2286850693853713,"_z":3.2159974016017943,"_order":"XYZ"},{"_x":4.1898938535632375,"_y":2.235032301518134,"_z":0.23024839790126958,"_order":"XYZ"},{"_x":3.5211848748208876,"_y":2.7567818753453714,"_z":0.3765502931395883,"_order":"XYZ"},{"_x":1.8279072895915771,"_y":6.277748783786023,"_z":4.616405104328517,"_order":"XYZ"},{"_x":1.2824405757009678,"_y":2.8107308348094397,"_z":1.103999093372555,"_order":"XYZ"},{"_x":5.977783277296149,"_y":2.6535751801184317,"_z":2.3546168807588375,"_order":"XYZ"},{"_x":5.903981891922039,"_y":1.9905500453242415,"_z":3.00966869965437,"_order":"XYZ"},{"_x":4.2273253977393255,"_y":4.396280746092852,"_z":0.9974194877507805,"_order":"XYZ"},{"_x":2.684816196244867,"_y":5.980075102766312,"_z":2.873572145664593,"_order":"XYZ"},{"_x":3.803146799647623,"_y":4.7351411361362565,"_z":2.6632889151208046,"_order":"XYZ"},{"_x":0.4885676451549626,"_y":6.224005377009155,"_z":0.3933784329469606,"_order":"XYZ"},{"_x":2.092737142221765,"_y":4.528044894217465,"_z":2.642867280903298,"_order":"XYZ"},{"_x":4.628263754870737,"_y":4.296383377928501,"_z":4.152368943823867,"_order":"XYZ"},{"_x":1.4216394639184324,"_y":2.5239585054175357,"_z":2.29746879981148,"_order":"XYZ"},{"_x":1.461480091705146,"_y":2.4538589618017435,"_z":2.4133062330910975,"_order":"XYZ"},{"_x":0.9301408362210423,"_y":3.1816421874247554,"_z":5.806026864430859,"_order":"XYZ"},{"_x":4.388106991458139,"_y":1.1056338241423453,"_z":2.075976942266979,"_order":"XYZ"}]
    var p=[{"x":-397.60636094554957,"y":535.4832342115161,"z":-347.9285585677072},{"x":-659.7620902899326,"y":694.5879898169607,"z":-39.49104847145391},{"x":-409.04411534885554,"y":-210.07413176975655,"z":-607.0215432366343},{"x":-287.2337774368563,"y":27.340971531365277,"z":-953.6743483855705},{"x":51.03125067855796,"y":516.3412529316682,"z":423.6597890451441},{"x":920.8579185030472,"y":-675.5829754292187,"z":403.4601300815255},{"x":228.59109617208563,"y":986.0485767508131,"z":-221.9815245971066},{"x":473.23116197483284,"y":728.3085281809458,"z":967.430735469263},{"x":95.83811179880186,"y":232.05217079773766,"z":917.1812278863141},{"x":-934.8296392429471,"y":530.0717433266233,"z":609.186655344577},{"x":907.7238022054397,"y":247.07124450422268,"z":437.16689608636193},{"x":-122.61446584073977,"y":678.4057725031416,"z":-12.504613964556377},{"x":-704.3015005091723,"y":435.38985730811277,"z":-556.3753445919639},{"x":311.7435204228656,"y":-672.2134929628534,"z":559.5641821140181},{"x":753.2180983161005,"y":-545.652986840663,"z":207.86267598365126},{"x":-95.82532496074636,"y":210.84250293194094,"z":371.23639021509945},{"x":444.9080568242048,"y":-413.631230153142,"z":891.4654625629281},{"x":644.387220129687,"y":830.783501173173,"z":-728.79145051887},{"x":553.7179775885601,"y":281.9245436624382,"z":691.842252826425},{"x":244.28353450771877,"y":-942.852131591644,"z":-370.1420346794393},{"x":-422.8415013347422,"y":-597.4058903333432,"z":-169.77284832410876},{"x":-184.9709819650771,"y":-687.4211718560322,"z":-312.22603437865894},{"x":-240.92725029691664,"y":669.9918928027198,"z":951.8478636072705},{"x":718.3351036454213,"y":-79.57988711906205,"z":-495.84843342593433},{"x":-694.6153679744009,"y":153.3390673248829,"z":-962.517812403696},{"x":243.21759465105552,"y":701.0468460377912,"z":29.794399896799995},{"x":556.0233008503004,"y":995.2147620070067,"z":-255.42941035021815},{"x":-540.3670059893249,"y":991.6362782750791,"z":45.77166017787171},{"x":187.04336214183303,"y":883.4724440440053,"z":-26.947712146008218},{"x":-428.68238259668436,"y":334.21983503382125,"z":-657.9354329153824},{"x":-326.7109754082411,"y":362.68168517151844,"z":409.4846958016292},{"x":404.5516189301579,"y":-175.46309794205683,"z":-204.8705224712486},{"x":-164.2563983151213,"y":-18.149162877057368,"z":-697.9627143671316},{"x":-869.3548112845684,"y":-739.3474888817915,"z":619.9394000223015},{"x":565.3322378382835,"y":872.9088680407924,"z":376.5372259875908},{"x":-838.2703465420071,"y":256.7690744171105,"z":-942.3845529602919},{"x":780.835453420658,"y":-866.6370818213851,"z":512.0304109665965},{"x":31.694685925205857,"y":-346.1860711191114,"z":-537.9011811715961},{"x":335.9161017714323,"y":-676.4749454085397,"z":-345.5651250449563},{"x":-657.7786377490061,"y":245.1564169288849,"z":75.66600759889752},{"x":498.20788839710684,"y":-806.5576908075682,"z":-112.77178806240241},{"x":-231.32778790885445,"y":630.0652697944313,"z":-591.9457608928669},{"x":-437.42028327096085,"y":-173.11322188757617,"z":921.0135528924876},{"x":7.356239268967446,"y":580.5442175915409,"z":345.35167230239773},{"x":871.6685021405932,"y":-635.5505641416861,"z":517.1153573470026},{"x":413.21867009242783,"y":-435.84830899217764,"z":-446.5642627155382},{"x":85.72683572959505,"y":-629.7359961071902,"z":-527.504777625885},{"x":-161.69360782900634,"y":-350.096234611446,"z":-114.92531633244774},{"x":-985.0194776116679,"y":693.0296610117117,"z":792.3620307833703},{"x":-7.737124188406774,"y":-466.15149418524516,"z":236.6019833124451},{"x":-365.7229824880708,"y":-44.06571950734195,"z":257.3515283984342},{"x":165.87293783107305,"y":729.9335537601488,"z":39.17617848027221},{"x":740.6171651867037,"y":730.8698099980937,"z":554.640477289857},{"x":-739.0401484486166,"y":265.0248852460551,"z":902.0761139547426},{"x":676.598019748361,"y":800.9211564829379,"z":-908.804599479418},{"x":851.8070599792633,"y":989.5228224788868,"z":570.0695173315604},{"x":-542.4946797617474,"y":360.94955906245696,"z":426.3677915419439},{"x":898.4263241142214,"y":-699.5491489403673,"z":294.98110832021183},{"x":-373.31586144386233,"y":-758.1842326562019,"z":-605.2342688072994},{"x":914.0114559205958,"y":-242.12095118954701,"z":-348.919921865205},{"x":247.3642152426496,"y":-274.86198210196557,"z":-805.6629043108519},{"x":-969.6037646452229,"y":-274.8503844845227,"z":601.7180850631596},{"x":505.6127884329715,"y":-218.43858379102787,"z":-33.87501921510383},{"x":-313.4154716084923,"y":-509.06535251633665,"z":119.7817087005344},{"x":249.4564238162682,"y":-671.2461375219458,"z":413.6247644613844},{"x":822.662167901838,"y":984.0202649530773,"z":-78.77102371184196},{"x":-582.3360587701059,"y":419.02859446679355,"z":575.9092060747748},{"x":652.0046412433436,"y":53.69566163513228,"z":-875.5482786591671},{"x":322.4123025125394,"y":199.36316633206852,"z":-931.8141411268201},{"x":-528.409794124566,"y":-673.7472686037594,"z":415.49530689847325},{"x":-404.1810589640482,"y":-154.49110437118696,"z":-666.1162276039195},{"x":112.93434573653683,"y":-901.1700294293403,"z":-751.7965761082266},{"x":608.0017272515521,"y":302.2189711919716,"z":174.98182980449516},{"x":93.88504138186082,"y":125.14427829263886,"z":-456.2200665448559},{"x":-709.848185467469,"y":-737.5342639418392,"z":-708.5961979193792},{"x":-665.1991652008551,"y":79.6524485964647,"z":-625.4681208221671},{"x":-618.4472009433968,"y":218.90119307022184,"z":213.0926172995453},{"x":-705.9836274406175,"y":991.2045171344204,"z":-218.29778007254674},{"x":750.5154466097376,"y":481.328435798011,"z":-579.07929232038},{"x":543.2668892916066,"y":897.922605353918,"z":-419.4356229524847},{"x":32.02752966117784,"y":-963.6638014827402,"z":-438.6445308846638},{"x":298.6993289381079,"y":110.67580484808248,"z":867.6430649343558},{"x":-450.6309832993676,"y":257.791624116225,"z":-123.32878392644098},{"x":77.58830578156717,"y":-30.01538683819094,"z":372.4468596417587},{"x":-192.65002096413798,"y":273.3041479787963,"z":-948.0553241050642},{"x":-380.18836232215847,"y":-886.0347679638783,"z":311.45498726420453},{"x":-165.90635751548223,"y":214.9367107175184,"z":173.33135701254542},{"x":842.342793583724,"y":254.49225043946643,"z":-690.9126221913526},{"x":-155.57823176354324,"y":-664.3808952212877,"z":-225.13815220331202},{"x":416.91068416481113,"y":524.9166492413542,"z":-107.79380391330307},{"x":278.6372283234564,"y":454.93213513487564,"z":872.7888969254152},{"x":478.9304417254758,"y":620.0354575124969,"z":763.9917320140057},{"x":88.12217010087097,"y":-706.8261847650024,"z":224.15237355925433},{"x":541.2476719034394,"y":-456.5546467806172,"z":-672.7362487744753},{"x":807.5267839016514,"y":-846.3527690708817,"z":-953.7923474639966},{"x":-741.3445056655323,"y":-317.45430344982896,"z":988.9348827542772},{"x":767.1607504764966,"y":322.74919764717856,"z":-252.91822397480513},{"x":-745.3114721757843,"y":-592.7989970972276,"z":356.93220714416276},{"x":-303.43332680710853,"y":-316.83512366116065,"z":278.2112786244508},{"x":838.3634261312238,"y":-358.37807627281217,"z":903.0488235605802}]
    var sc=[{"x":28.553632272247786,"y":28.553632272247786,"z":28.553632272247786},{"x":14.793848299977777,"y":14.793848299977777,"z":14.793848299977777},{"x":20.899023574915564,"y":20.899023574915564,"z":20.899023574915564},{"x":18.78818097445333,"y":18.78818097445333,"z":18.78818097445333},{"x":27.939026855268057,"y":27.939026855268057,"z":27.939026855268057},{"x":26.273248602617567,"y":26.273248602617567,"z":26.273248602617567},{"x":16.009525346609166,"y":16.009525346609166,"z":16.009525346609166},{"x":15.6003356906592,"y":15.6003356906592,"z":15.6003356906592},{"x":16.084115170650406,"y":16.084115170650406,"z":16.084115170650406},{"x":15.182435780988497,"y":15.182435780988497,"z":15.182435780988497},{"x":16.628884029339,"y":16.628884029339,"z":16.628884029339},{"x":17.275578186096446,"y":17.275578186096446,"z":17.275578186096446},{"x":17.864743428532766,"y":17.864743428532766,"z":17.864743428532766},{"x":28.307084850970682,"y":28.307084850970682,"z":28.307084850970682},{"x":24.959226825294806,"y":24.959226825294806,"z":24.959226825294806},{"x":13.973570322208047,"y":13.973570322208047,"z":13.973570322208047},{"x":17.253854966036943,"y":17.253854966036943,"z":17.253854966036943},{"x":18.062420110140085,"y":18.062420110140085,"z":18.062420110140085},{"x":26.055413285683468,"y":26.055413285683468,"z":26.055413285683468},{"x":17.37609114717609,"y":17.37609114717609,"z":17.37609114717609},{"x":11.640729472419826,"y":11.640729472419826,"z":11.640729472419826},{"x":27.679573100179518,"y":27.679573100179518,"z":27.679573100179518},{"x":19.832762356485077,"y":19.832762356485077,"z":19.832762356485077},{"x":25.682891287698276,"y":25.682891287698276,"z":25.682891287698276},{"x":24.78684608679288,"y":24.78684608679288,"z":24.78684608679288},{"x":16.165721725660266,"y":16.165721725660266,"z":16.165721725660266},{"x":23.64966035034972,"y":23.64966035034972,"z":23.64966035034972},{"x":20.73034403678818,"y":20.73034403678818,"z":20.73034403678818},{"x":22.161311772913045,"y":22.161311772913045,"z":22.161311772913045},{"x":17.389422618795898,"y":17.389422618795898,"z":17.389422618795898},{"x":22.814649323329014,"y":22.814649323329014,"z":22.814649323329014},{"x":21.156578337119424,"y":21.156578337119424,"z":21.156578337119424},{"x":29.423486026649336,"y":29.423486026649336,"z":29.423486026649336},{"x":23.614012042985017,"y":23.614012042985017,"z":23.614012042985017},{"x":24.00862692686779,"y":24.00862692686779,"z":24.00862692686779},{"x":15.745574920557068,"y":15.745574920557068,"z":15.745574920557068},{"x":13.683010403480743,"y":13.683010403480743,"z":13.683010403480743},{"x":22.73480177803311,"y":22.73480177803311,"z":22.73480177803311},{"x":27.1386574378117,"y":27.1386574378117,"z":27.1386574378117},{"x":24.84223925663922,"y":24.84223925663922,"z":24.84223925663922},{"x":24.024636951585357,"y":24.024636951585357,"z":24.024636951585357},{"x":17.55260761111677,"y":17.55260761111677,"z":17.55260761111677},{"x":18.59850692553595,"y":18.59850692553595,"z":18.59850692553595},{"x":15.207815682496761,"y":15.207815682496761,"z":15.207815682496761},{"x":21.784541845814438,"y":21.784541845814438,"z":21.784541845814438},{"x":15.422668695806575,"y":15.422668695806575,"z":15.422668695806575},{"x":29.881045182260124,"y":29.881045182260124,"z":29.881045182260124},{"x":14.691565542134155,"y":14.691565542134155,"z":14.691565542134155},{"x":21.136577800887405,"y":21.136577800887405,"z":21.136577800887405},{"x":29.65854329862111,"y":29.65854329862111,"z":29.65854329862111},{"x":25.264845151753228,"y":25.264845151753228,"z":25.264845151753228},{"x":28.6807386141421,"y":28.6807386141421,"z":28.6807386141421},{"x":21.546994255113326,"y":21.546994255113326,"z":21.546994255113326},{"x":18.90056111923741,"y":18.90056111923741,"z":18.90056111923741},{"x":25.390222512838694,"y":25.390222512838694,"z":25.390222512838694},{"x":24.907545641521146,"y":24.907545641521146,"z":24.907545641521146},{"x":14.726874109583466,"y":14.726874109583466,"z":14.726874109583466},{"x":26.107219487270328,"y":26.107219487270328,"z":26.107219487270328},{"x":26.322110993680134,"y":26.322110993680134,"z":26.322110993680134},{"x":16.789731796458014,"y":16.789731796458014,"z":16.789731796458014},{"x":20.968872047033248,"y":20.968872047033248,"z":20.968872047033248},{"x":15.930863591943885,"y":15.930863591943885,"z":15.930863591943885},{"x":25.005928438161785,"y":25.005928438161785,"z":25.005928438161785},{"x":26.68693580604728,"y":26.68693580604728,"z":26.68693580604728},{"x":20.59605197251601,"y":20.59605197251601,"z":20.59605197251601},{"x":26.695160460065296,"y":26.695160460065296,"z":26.695160460065296},{"x":10.823543996842808,"y":10.823543996842808,"z":10.823543996842808},{"x":26.132961372110447,"y":26.132961372110447,"z":26.132961372110447},{"x":23.71382994113247,"y":23.71382994113247,"z":23.71382994113247},{"x":29.450662967997758,"y":29.450662967997758,"z":29.450662967997758},{"x":24.040984771632846,"y":24.040984771632846,"z":24.040984771632846},{"x":15.301674307189721,"y":15.301674307189721,"z":15.301674307189721},{"x":29.561382042909187,"y":29.561382042909187,"z":29.561382042909187},{"x":11.696119246408557,"y":11.696119246408557,"z":11.696119246408557},{"x":25.426910207144733,"y":25.426910207144733,"z":25.426910207144733},{"x":13.469846059737902,"y":13.469846059737902,"z":13.469846059737902},{"x":13.170759415709936,"y":13.170759415709936,"z":13.170759415709936},{"x":27.61669028391445,"y":27.61669028391445,"z":27.61669028391445},{"x":24.75739471074819,"y":24.75739471074819,"z":24.75739471074819},{"x":20.449382658202598,"y":20.449382658202598,"z":20.449382658202598},{"x":13.2782693042248,"y":13.2782693042248,"z":13.2782693042248},{"x":28.24248262798512,"y":28.24248262798512,"z":28.24248262798512},{"x":12.69952912759087,"y":12.69952912759087,"z":12.69952912759087},{"x":13.244715695618616,"y":13.244715695618616,"z":13.244715695618616},{"x":24.570770453892848,"y":24.570770453892848,"z":24.570770453892848},{"x":21.991196537765706,"y":21.991196537765706,"z":21.991196537765706},{"x":14.924472310784047,"y":14.924472310784047,"z":14.924472310784047},{"x":28.66830959526437,"y":28.66830959526437,"z":28.66830959526437},{"x":25.980241033955615,"y":25.980241033955615,"z":25.980241033955615},{"x":19.69808686485466,"y":19.69808686485466,"z":19.69808686485466},{"x":15.327810170290931,"y":15.327810170290931,"z":15.327810170290931},{"x":11.41443030114296,"y":11.41443030114296,"z":11.41443030114296},{"x":29.626767215903502,"y":29.626767215903502,"z":29.626767215903502},{"x":18.557603700737765,"y":18.557603700737765,"z":18.557603700737765},{"x":15.211068580126978,"y":15.211068580126978,"z":15.211068580126978},{"x":19.722077825776093,"y":19.722077825776093,"z":19.722077825776093},{"x":16.996639674663975,"y":16.996639674663975,"z":16.996639674663975},{"x":23.54460401080942,"y":23.54460401080942,"z":23.54460401080942},{"x":27.676187038091143,"y":27.676187038091143,"z":27.676187038091143},{"x":23.16510259547663,"y":23.16510259547663,"z":23.16510259547663}]
    for( var j = 0; j < 100 ; j++ ) {
      var m = new Object3D();
      m.rotation.set(rr[j]._x, rr[j]._y, rr[j]._z);
      m.position.set(p[j].x, p[j].y, p[j].z);
      //m.rotation.set( Math.random() * 2 * Math.PI, Math.random() * 2 * Math.PI, Math.random() * 2 * Math.PI );
      // m.position.set( ( .5 - Math.random() ) * r, ( .5 - Math.random() ) * r, ( .5 - Math.random() ) * r );
      var scale = 10 + Math.random() * 20;

      // m.scale.set( scale, scale, scale );
      m.scale.set( sc[j].x, sc[j].y, sc[j].z );
      sc.push(m.scale);
      m.updateMatrix()
      gg.push(s.clone().applyMatrix4(m.matrix));
    }

    const mg = mergeBufferGeometries(gg)
    const model = new Mesh( mg, this.modelMaterial );
    mg.computeBoundingSphere();
    model.castShadow = true;
    model.receiveShadow = true;
    this.scene.add( model );

  }

  animate () {
    requestAnimationFrame(this.animate.bind(this))

    const t = .001 * Date.now();

    // this.light.position.set( 0, 3000 * Math.cos( t ), 2000 * Math.sin( t ) );

    if( this.bloomPass.options.useTexture ) {
      this.scene.overrideMaterial = this.glowMaterial;
      this.renderer.setRenderTarget( this.glowTexture );
      this.renderer.render( this.scene, this.camera );
      this.renderer.setRenderTarget( null );
      this.scene.overrideMaterial = null;
      this.bloomPass.options.glowTexture = this.glowTexture.texture;
    }

    this.composer.render();

  }
}
export default Main
